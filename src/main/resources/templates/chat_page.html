<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>Wine|chat_page</title>
  <script>
    const chat_type = "[[${chat_type}]]";
    const receiver = "[[${receiver}]]";

    window.onload = () => {
      let sse = new EventSource("/chat_page" + chat_type + "/update?receiver=" + receiver);

      sse.onmessage = (event) => {
        let dataList = JSON.parse(event.data);

        let chatArea = document.getElementById("chat_area");
        while (chatArea.firstChild) {
          chatArea.removeChild(chatArea.firstChild);
        }

        Array.from(dataList).forEach(chat => {
          let chatSender = document.createElement("p");
          chatSender.textContent = chat.sender;
          let chatDateTime = document.createElement("p");
          chatDateTime.textContent = chat.date_time;

          let chatInfo = document.createElement("div");
          chatInfo.appendChild(chatSender);
          chatInfo.appendChild(chatDateTime);

          let chatData = document.createElement("div");
          chatData.textContent = chat.chat_data;

          let chatLine = document.createElement("div");
          chatLine.appendChild(chatInfo);
          chatLine.appendChild(chatData);

          chatArea.appendChild(chatLine);
        });
      };
    };
  </script>
</head>

<body>
  <a href="/">戻る</a>

  <h1 th:if="${receiver}" id="receiver">[[${receiver}]]</h1>

  <h2 th:if="${message}">[[${message}]]</h2>

  <div id="chat_area"></div>

  <form th:action="@{'/chat_page' + ${chat_type} + '/send'}" method="POST">
    <p>
      <input type="submit" value="送信">
    </p>
    <p>
      <textarea name="chat_data" cols="30" rows="10"></textarea>
    </p>
    <p>
      <input type="hidden" name="receiver" th:value="${receiver}">
    </p>
  </form>

  <p>
    <a href="/login_user/logout">ログアウト</a>
  </p>
</body>

</html>
