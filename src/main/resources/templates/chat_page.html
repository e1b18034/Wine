<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>Wine|chat_page</title>
  <link rel="stylesheet" href="/css/chat_page.css">
  <script>
    const chat_type = "[[${chat_type}]]";
    const receiver = "[[${receiver}]]";

    window.onload = () => {
      let sse = new EventSource("/chat_page" + chat_type + "/update?receiver=" + receiver);

      sse.onmessage = (event) => {
        let dataList = JSON.parse(event.data);

        let chatArea = document.getElementById("chat_area");
        while (chatArea.firstChild) {
          chatArea.removeChild(chatArea.firstChild);
        }

        Array.from(dataList).forEach(chat => {
          let sender = document.createElement("p");
          sender.textContent = chat.sender;

          let dateTime = document.createElement("small");
          dateTime.textContent = chat.date_time;

          let chatInfo = document.createElement("th");
          chatInfo.setAttribute("class","chat_info");
          chatInfo.appendChild(sender);
          chatInfo.appendChild(dateTime);

          let chatData = document.createElement("p");
          chatData.textContent = chat.chat_data;
          chatData.setAttribute("class","chat_data");

          let chatDataParent = document.createElement("td");
          chatDataParent.setAttribute("class","chat_data_parent");
          chatDataParent.appendChild(chatData);

          let chatLine = document.createElement("tr");
          chatLine.setAttribute("class","chat_line");
          chatLine.appendChild(chatInfo);
          chatLine.appendChild(chatData);

          let table = document.createElement("table");
          table.setAttribute("class","chat_line_table");
          table.appendChild(chatLine);

          chatArea.appendChild(table);
        });
      };
    };
  </script>
</head>

<body>
  <a id="page_back" th:href="@{${chat_home}}">戻る</a>

  <div id="action">
    <h1 th:if="${receiver}" id="receiver">[[${receiver}]]</h1>

    <p th:if="${message}">[[${message}]]</p>

    <div id="chat_area"></div>
  </div>

  <div id="chat_form">
    <form th:action="@{'/chat_page' + ${chat_type} + '/send'}" method="POST">
      <p>
        <input type="submit" value="送信">
      </p>
      <p>
        <textarea name="chat_data" rows="12"></textarea>
      </p>
      <p>
        <input type="hidden" name="receiver" th:value="${receiver}">
      </p>
    </form>
  </div>
</body>

</html>
